<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calibre9 - SEO Revenue Forecasting Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Oswald:wght@200;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --accent:#ff00ff;--accent-light:#ff66ff;
  --success:#00ff00;--indigo:#6610f2;
  --warn:#ffcc00;--danger:#ff3333;
  --bg:#1a1a1a;--bg2:#1f1f1f;--card:#242424;
  --fg:#ffffff;--fg2:#b0b0b0;
  --border:#3a3a3a;--input:#1f1f1f;
}
body{font-family:'Montserrat',sans-serif;font-size:15px;background:linear-gradient(135deg,var(--bg),var(--bg2));color:var(--fg);min-height:100vh;padding:2rem;overflow-x:hidden;}
body::before{content:'';position:fixed;top:-50%;right:-50%;width:100%;height:100%;background:radial-gradient(circle,rgba(255,0,255,0.07) 0%,transparent 70%);pointer-events:none;animation:pulse 8s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:.3;transform:scale(1);}50%{opacity:.5;transform:scale(1.1);}}
@keyframes slideDown{from{opacity:0;transform:translateY(-30px);}to{opacity:1;transform:translateY(0);}}
@keyframes fadeIn{from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);}}

.container{max-width:1600px;margin:0 auto;position:relative;z-index:1;}
header{text-align:center;margin-bottom:2.5rem;animation:slideDown .6s ease-out;}
h1{font-family:'Bebas Neue',sans-serif;font-size:4.5rem;letter-spacing:-0.02em;background:linear-gradient(135deg,var(--accent),var(--accent-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-transform:uppercase;}
.subtitle{font-family:'Oswald',sans-serif;font-weight:200;color:var(--fg2);font-size:1.4rem;letter-spacing:-0.02em;text-transform:uppercase;}
.brand-input{margin:1.5rem auto;max-width:400px;}
.brand-input input{width:100%;padding:1rem 1.5rem;background:var(--input);border:2px solid var(--border);border-radius:12px;color:var(--fg);font-size:1rem;font-family:'Montserrat',sans-serif;text-align:center;transition:all .3s;}
.brand-input input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 4px rgba(255,0,255,.1);}

/* ‚îÄ‚îÄ MODE TOGGLE ‚îÄ‚îÄ */
.mode-toggle{display:flex;justify-content:center;margin-bottom:2rem;gap:0;}
.mode-btn{padding:.85rem 3rem;font-family:'Montserrat',sans-serif;font-weight:700;font-size:1rem;letter-spacing:-.02em;text-transform:uppercase;border:2px solid var(--border);background:transparent;color:var(--fg2);cursor:pointer;transition:all .3s;}
.mode-btn:first-child{border-radius:12px 0 0 12px;}
.mode-btn:last-child{border-radius:0 12px 12px 0;}
.mode-btn.active{background:linear-gradient(135deg,var(--accent),var(--accent-light));border-color:var(--accent);color:#fff;}
.mode-badge{display:inline-block;margin-left:.5rem;padding:.1rem .5rem;font-size:.7rem;border-radius:20px;background:rgba(0,255,0,.2);color:var(--success);border:1px solid var(--success);}

/* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:1.5rem;margin-bottom:1.5rem;}
.card{background:var(--card);border-radius:16px;padding:1.75rem;border:1px solid var(--border);box-shadow:0 10px 40px rgba(0,0,0,.3);transition:all .4s;animation:fadeIn .5s ease-out backwards;}
.card:hover{transform:translateY(-3px);box-shadow:0 15px 50px rgba(0,0,0,.4);}
.c12{grid-column:span 12;}.c8{grid-column:span 8;}.c6{grid-column:span 6;}.c4{grid-column:span 4;}.c3{grid-column:span 3;}
@media(max-width:1100px){.c8,.c6,.c4,.c3{grid-column:span 12;}}

.card-title{font-family:'Bebas Neue',sans-serif;font-size:1.9rem;letter-spacing:-.02em;color:var(--fg);margin-bottom:1.25rem;display:flex;align-items:center;gap:.7rem;text-transform:uppercase;}
.card-title .icon{width:38px;height:38px;background:linear-gradient(135deg,var(--accent),var(--accent-light));border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0;}

/* ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ */
.igroup{margin-bottom:1.25rem;}
.igroup label{display:block;font-family:'Montserrat',sans-serif;font-size:.82rem;font-weight:700;color:var(--fg2);margin-bottom:.4rem;text-transform:uppercase;letter-spacing:-.02em;}
.igroup input,.igroup select{width:100%;padding:.8rem 1.1rem;background:var(--input);border:1px solid var(--border);border-radius:10px;color:var(--fg);font-size:.95rem;font-family:'Montserrat',sans-serif;transition:all .3s;}
.igroup input:focus,.igroup select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,0,255,.1);}
.igroup input.optional{border-style:dashed;border-color:#555;}
.igroup input.optional:focus{border-style:solid;}
.opt-label{font-size:.7rem;color:#666;font-style:italic;margin-left:.4rem;}
.igrid2{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
.igrid4{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;}
@media(max-width:900px){.igrid4{grid-template-columns:1fr 1fr;}}

/* ‚îÄ‚îÄ HELPERS & BADGES ‚îÄ‚îÄ */
.hint{font-size:.78rem;color:var(--fg2);font-style:italic;margin-top:.4rem;padding:.6rem .8rem;background:rgba(255,0,255,.05);border-radius:6px;border-left:3px solid var(--accent);}
.warn-hint{border-left-color:var(--warn);background:rgba(255,204,0,.05);}
.badge{display:inline-flex;align-items:center;gap:.4rem;padding:.35rem .9rem;border-radius:20px;font-family:'Montserrat',sans-serif;font-size:.78rem;font-weight:700;letter-spacing:-.02em;}
.badge-green{background:rgba(0,255,0,.15);border:1px solid var(--success);color:var(--success);}
.badge-magenta{background:rgba(255,0,255,.15);border:1px solid var(--accent);color:var(--accent);}
.badge-indigo{background:rgba(102,16,242,.2);border:1px solid var(--indigo);color:#a78bfa;}
.badge-warn{background:rgba(255,204,0,.15);border:1px solid var(--warn);color:var(--warn);}
.badge-danger{background:rgba(255,51,51,.15);border:1px solid var(--danger);color:var(--danger);}

/* ‚îÄ‚îÄ METRIC CARD ‚îÄ‚îÄ */
.mcard{background:linear-gradient(135deg,#242424,#1a1a1a);padding:1.25rem;border-radius:12px;text-align:center;border:1px solid var(--indigo);}
.mcard-label{font-family:'Montserrat',sans-serif;font-size:.82rem;font-weight:700;color:var(--fg2);text-transform:uppercase;letter-spacing:-.02em;margin-bottom:.4rem;}
.mcard-value{font-family:'Bebas Neue',sans-serif;font-size:2.6rem;letter-spacing:-.02em;color:var(--fg);}
.mcard-value.green{color:var(--success);}
.mcard-value.magenta{background:linear-gradient(135deg,var(--accent),var(--accent-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}

/* ‚îÄ‚îÄ CONFIDENCE METER ‚îÄ‚îÄ */
.conf-meter{margin-top:1rem;}
.conf-label{display:flex;justify-content:space-between;margin-bottom:.4rem;font-size:.8rem;color:var(--fg2);font-weight:700;}
.conf-track{height:8px;background:var(--border);border-radius:4px;overflow:hidden;}
.conf-fill{height:100%;border-radius:4px;transition:width .6s ease;background:linear-gradient(90deg,var(--indigo),var(--accent),var(--success));}

/* ‚îÄ‚îÄ SCENARIO TABS ‚îÄ‚îÄ */
.stabs{display:flex;gap:.4rem;margin-bottom:1.25rem;border-bottom:2px solid var(--border);padding-bottom:.4rem;}
.stab{padding:.6rem 1.2rem;background:transparent;border:none;color:var(--fg2);font-family:'Montserrat',sans-serif;font-size:.9rem;font-weight:700;cursor:pointer;transition:all .3s;border-radius:6px 6px 0 0;position:relative;letter-spacing:-.02em;}
.stab.active{color:var(--accent);background:rgba(255,0,255,.1);}
.stab.active::after{content:'';position:absolute;bottom:-2px;left:0;right:0;height:2px;background:var(--accent);}

/* ‚îÄ‚îÄ RESULTS ‚îÄ‚îÄ */
.results-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-top:1.25rem;}
@media(max-width:800px){.results-grid{grid-template-columns:1fr;}}
.result-box{background:var(--input);padding:1.25rem;border-radius:12px;border:1px solid var(--border);text-align:center;transition:all .3s;}
.result-box:hover{transform:translateY(-2px);}
.result-box.cons{border-left:4px solid var(--indigo);}
.result-box.mod{border-left:4px solid var(--success);}
.result-box.opt{border-left:4px solid var(--accent);}
.result-box h4{font-family:'Montserrat',sans-serif;font-size:.88rem;font-weight:700;color:var(--fg2);margin-bottom:.75rem;text-transform:uppercase;letter-spacing:-.02em;}
.rval{font-family:'Bebas Neue',sans-serif;font-size:2.8rem;letter-spacing:-.02em;color:var(--fg);margin-bottom:.3rem;}
.rlabel{font-size:.82rem;color:var(--fg2);}
.rdiv{margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--border);}

/* ‚îÄ‚îÄ CHART ‚îÄ‚îÄ */
.chart-wrap{position:relative;height:310px;margin-top:.75rem;}
.chart-wrap-tall{position:relative;height:360px;margin-top:.75rem;}

/* ‚îÄ‚îÄ AHREFS PANEL ‚îÄ‚îÄ */
.ahrefs-section{background:rgba(102,16,242,.08);border:1px solid var(--indigo);border-radius:12px;padding:1.25rem;margin-bottom:1.25rem;}
.ahrefs-section-title{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:-.02em;color:#a78bfa;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem;}
.ahrefs-section-title span{font-size:1rem;}

/* ‚îÄ‚îÄ SIGNAL INDICATORS ‚îÄ‚îÄ */
.signals{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:1rem;}
.signal-item{padding:.4rem .8rem;border-radius:8px;font-size:.78rem;font-weight:700;font-family:'Montserrat',sans-serif;}

/* ‚îÄ‚îÄ DR GAUGE ‚îÄ‚îÄ */
.kd-bar-wrap{margin-top:.5rem;}
.kd-bar-label{display:flex;justify-content:space-between;font-size:.75rem;color:var(--fg2);margin-bottom:.3rem;}
.kd-bar-track{height:6px;background:var(--border);border-radius:3px;overflow:hidden;}
.kd-bar-fill{height:100%;border-radius:3px;transition:width .5s ease;}

/* ‚îÄ‚îÄ TIMELINE BADGE ‚îÄ‚îÄ */
.timeline-badge{display:inline-block;padding:.4rem .9rem;background:rgba(0,255,0,.15);border:1px solid var(--success);border-radius:20px;font-family:'Montserrat',sans-serif;font-size:.82rem;font-weight:700;color:var(--success);letter-spacing:-.02em;}

/* ‚îÄ‚îÄ NOTE SECTION ‚îÄ‚îÄ */
.note-section{background:var(--input);padding:1.5rem;border-radius:12px;border-left:4px solid var(--accent);margin-top:1.5rem;}
.note-section h3{font-family:'Bebas Neue',sans-serif;font-size:1.7rem;margin-bottom:.75rem;color:var(--accent);letter-spacing:-.02em;text-transform:uppercase;}
.note-section ul{list-style:none;padding:0;}
.note-section li{padding:.4rem 0;padding-left:1.4rem;position:relative;color:var(--fg2);line-height:1.6;font-size:.88rem;}
.note-section li::before{content:'‚Üí';position:absolute;left:0;color:var(--accent);font-weight:700;}

/* ‚îÄ‚îÄ ADVANCED HIDDEN ‚îÄ‚îÄ */
.advanced-only{display:none;}
.basic-only{}

footer{text-align:center;margin-top:3rem;padding-top:1.5rem;border-top:1px solid var(--border);color:var(--fg2);font-size:.85rem;}

/* ‚îÄ‚îÄ STAGGER CHART ‚îÄ‚îÄ */
.stagger-chart-wrap{position:relative;height:420px;margin-top:.75rem;}
.stagger-legend{display:flex;gap:1.5rem;flex-wrap:wrap;margin-bottom:1rem;}
.stagger-legend-item{display:flex;align-items:center;gap:.5rem;font-size:.82rem;color:var(--fg2);font-family:'Montserrat',sans-serif;font-weight:700;}
.stagger-legend-dot{width:12px;height:12px;border-radius:2px;flex-shrink:0;}

/* ‚îÄ‚îÄ HISTORICAL DATA ‚îÄ‚îÄ */
.hist-header{display:flex;align-items:center;gap:1rem;margin-bottom:1.25rem;flex-wrap:wrap;}
.hist-month-count{display:flex;align-items:center;gap:.75rem;}
.hist-month-count label{font-size:.82rem;font-weight:700;color:var(--fg2);text-transform:uppercase;letter-spacing:-.02em;white-space:nowrap;}
.hist-month-count select{padding:.5rem .9rem;background:var(--input);border:1px solid var(--border);border-radius:8px;color:var(--fg);font-family:'Montserrat',sans-serif;font-size:.9rem;cursor:pointer;}
.hist-month-count select:focus{outline:none;border-color:var(--accent);}
.hist-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:.75rem;margin-bottom:1.25rem;}
.hist-input-wrap{background:var(--input);border:1px solid var(--border);border-radius:10px;padding:.85rem;transition:border-color .2s;}
.hist-input-wrap:hover{border-color:rgba(255,0,255,.3);}
.hist-input-wrap label{display:block;font-size:.72rem;font-weight:700;color:var(--fg2);text-transform:uppercase;letter-spacing:-.02em;margin-bottom:.4rem;}
.hist-input-wrap input{width:100%;background:transparent;border:none;color:var(--fg);font-family:'Montserrat',sans-serif;font-size:1rem;font-weight:700;outline:none;}
.hist-input-wrap input::placeholder{color:#555;font-weight:400;}
.hist-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.25rem;}
@media(max-width:900px){.hist-stats{grid-template-columns:1fr 1fr;}}
.hist-stat{background:var(--input);border-radius:10px;padding:1rem;text-align:center;border:1px solid var(--border);}
.hist-stat-label{font-size:.72rem;font-weight:700;color:var(--fg2);text-transform:uppercase;letter-spacing:-.02em;margin-bottom:.35rem;}
.hist-stat-value{font-family:'Bebas Neue',sans-serif;font-size:1.9rem;letter-spacing:-.02em;}
.hist-chart-wrap{position:relative;height:380px;margin-top:.5rem;}
.growth-badge{display:inline-flex;align-items:center;gap:.4rem;padding:.3rem .8rem;border-radius:20px;font-size:.75rem;font-weight:700;font-family:'Montserrat',sans-serif;margin-left:auto;}
.growth-pos{background:rgba(0,255,0,.15);border:1px solid var(--success);color:var(--success);}
.growth-neg{background:rgba(255,51,51,.15);border:1px solid var(--danger);color:var(--danger);}
</style>
</head>
<body>
<div class="container">

  <!-- HEADER -->
  <header>
    <h1>Calibre9</h1>
    <p class="subtitle">SEO Revenue Forecasting Dashboard</p>
    <div class="brand-input">
      <input type="text" id="brandName" placeholder="Enter Client / Brand Name" value="Your Brand">
    </div>
  </header>

  <!-- MODE TOGGLE -->
  <div class="mode-toggle">
    <button class="mode-btn active" id="btnBasic" onclick="setMode('basic')">Basic</button>
    <button class="mode-btn" id="btnAdvanced" onclick="setMode('advanced')">Advanced <span class="mode-badge">Ahrefs</span></button>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ROW 1 ‚Äî CORE INPUTS
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="grid" id="coreGrid">

    <!-- Core Metrics -->
    <div class="card c4">
      <h2 class="card-title"><span class="icon">‚öôÔ∏è</span>Core Metrics</h2>
      <div class="igroup">
        <label>Conversion Rate (%)</label>
        <input type="number" id="conversionRate" value="3.2" step="0.1" min="0">
      </div>
      <div class="igroup">
        <label>Average Order Value ($)</label>
        <input type="number" id="aov" value="285" step="1" min="0">
      </div>
      <div class="igroup">
        <label>% Commercial Keywords</label>
        <input type="number" id="commercialPercent" value="42" step="1" min="0" max="100">
      </div>
      <div class="igroup">
        <label>Current Monthly Traffic</label>
        <input type="number" id="currentTraffic" value="2800" step="1" min="0">
        <p class="hint">üí° Organic visitors from Google Analytics / Search Console</p>
      </div>
    </div>

    <!-- Keyword Data -->
    <div class="card c8">
      <h2 class="card-title"><span class="icon">üîç</span>Keyword Opportunity <span id="dataSourceBadge" class="badge badge-indigo" style="font-size:.7rem;margin-left:.5rem;">Basic Mode</span></h2>

      <div class="igrid2">
        <div class="igroup">
          <label>Current Rankings (4‚Äì50) ‚Äî Count</label>
          <input type="number" id="currentKeywords" value="280" min="0">
        </div>
        <div class="igroup">
          <label>Current Rankings (4‚Äì50) ‚Äî Search Volume</label>
          <input type="number" id="currentVolume" value="85000" min="0">
        </div>
        <div class="igroup">
          <label>Competitor Gap Keywords ‚Äî Count</label>
          <input type="number" id="gapKeywords" value="320" min="0">
        </div>
        <div class="igroup">
          <label>Competitor Gap ‚Äî Search Volume</label>
          <input type="number" id="gapVolume" value="95000" min="0">
        </div>
      </div>

      <!-- ADVANCED: Ahrefs inputs -->
      <div class="advanced-only">
        <div class="ahrefs-section">
          <div class="ahrefs-section-title"><span>üü£</span> Ahrefs ‚Äî Client Profile (Steps 1 &amp; 2) ¬∑ Site Explorer ‚Üí Organic Keywords ‚Üí filter pos 4‚Äì50</div>
          <div class="igrid4">
            <div class="igroup">
              <label>Client Domain Rating <span class="opt-label">optional</span></label>
              <input type="number" id="clientDR" class="optional" placeholder="e.g. 42" min="0" max="100">
            </div>
            <div class="igroup">
              <label>Client Ref. Domains <span class="opt-label">optional</span></label>
              <input type="number" id="clientRD" class="optional" placeholder="e.g. 850" min="0">
            </div>
            <div class="igroup">
              <label>Avg. Competitor DR <span class="opt-label">optional</span></label>
              <input type="number" id="compDR" class="optional" placeholder="e.g. 58" min="0" max="100">
            </div>
            <div class="igroup">
              <label>Avg. Competitor Ref. Domains <span class="opt-label">optional</span></label>
              <input type="number" id="compRD" class="optional" placeholder="e.g. 1400" min="0">
            </div>
          </div>
          <div class="ahrefs-section-title" style="margin-top:.75rem;"><span>üîë</span> Ahrefs ‚Äî Keyword Data (Steps 3 &amp; 4) ‚Äî Export positions 4‚Äì50</div>
          <div class="igrid4">
            <div class="igroup">
              <label>Avg. Keyword Difficulty (KD) <span class="opt-label">optional</span></label>
              <input type="number" id="avgKD" class="optional" placeholder="0‚Äì100" min="0" max="100">
            </div>
            <div class="igroup">
              <label>% SERP Features (snippets etc.) <span class="opt-label">optional</span></label>
              <input type="number" id="serpFeaturePct" class="optional" placeholder="e.g. 25" min="0" max="100">
            </div>
            <div class="igroup">
              <label>Avg. CPC of Gap Keywords ($) <span class="opt-label">optional</span></label>
              <input type="number" id="avgCPC" class="optional" placeholder="e.g. 1.80" step="0.01" min="0">
            </div>
            <div class="igroup">
              <label>Client Org. Traffic (Ahrefs) <span class="opt-label">optional</span></label>
              <input type="number" id="ahrefsTraffic" class="optional" placeholder="e.g. 4200" min="0">
            </div>
          </div>

          <!-- Computed signals -->
          <div id="ahrefsSignals" class="signals"></div>
        </div>
      </div>

      <div class="mcard" style="margin-top:.75rem;">
        <div class="mcard-label">Total Keyword Opportunity</div>
        <div class="mcard-value magenta" id="totalOpportunity">600 Keywords ¬∑ 180,000 Volume</div>
      </div>
    </div>

  </div><!-- /ROW 1 -->

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ROW 2 ‚Äî MODELLING INPUTS
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="grid">

    <!-- Forecast Scenarios -->
    <div class="card c4">
      <h2 class="card-title"><span class="icon">üéØ</span>Forecast Scenarios</h2>
      <div class="stabs">
        <button class="stab active" onclick="switchScenario('conservative',event)">Conservative</button>
        <button class="stab" onclick="switchScenario('moderate',event)">Moderate</button>
        <button class="stab" onclick="switchScenario('optimistic',event)">Optimistic</button>
      </div>

      <div style="background:rgba(102,16,242,.08);border-radius:10px;padding:.85rem;margin-bottom:.85rem;border:1px solid rgba(102,16,242,.3);">
        <div style="font-family:'Montserrat',sans-serif;font-size:.72rem;font-weight:700;color:#a78bfa;text-transform:uppercase;letter-spacing:-.02em;margin-bottom:.65rem;">üèÜ Positions 1‚Äì5 (High CTR Band)</div>
        <div class="igrid2">
          <div class="igroup" style="margin-bottom:0;">
            <label>% Keywords Reaching Top 5</label>
            <input type="number" id="scenarioTop5Reach" value="20" step="1" min="0" max="100">
          </div>
          <div class="igroup" style="margin-bottom:0;">
            <label>Blended CTR Pos 1‚Äì5 (%)</label>
            <input type="number" id="scenarioTop5CTR" value="15" step="0.1" min="0" max="100">
          </div>
        </div>
      </div>

      <div style="background:rgba(0,255,0,.05);border-radius:10px;padding:.85rem;margin-bottom:.85rem;border:1px solid rgba(0,255,0,.2);">
        <div style="font-family:'Montserrat',sans-serif;font-size:.72rem;font-weight:700;color:var(--success);text-transform:uppercase;letter-spacing:-.02em;margin-bottom:.65rem;">üìä Positions 6‚Äì10 (Additional Band)</div>
        <div class="igrid2">
          <div class="igroup" style="margin-bottom:0;">
            <label>% Keywords Reaching 6‚Äì10</label>
            <input type="number" id="scenarioTop10Reach" value="35" step="1" min="0" max="100">
          </div>
          <div class="igroup" style="margin-bottom:0;">
            <label>Blended CTR Pos 6‚Äì10 (%)</label>
            <input type="number" id="scenarioTop10CTR" value="4" step="0.1" min="0" max="100">
          </div>
        </div>
      </div>

      <p class="hint">üîß CTR values from Advanced Web Ranking / industry tool</p>
      <div class="timeline-badge" id="timeline" style="margin-top:.75rem;display:block;">Full results: Month 9‚Äì12</div>

      <!-- Confidence score -->
      <div class="conf-meter" style="margin-top:.85rem;">
        <div class="conf-label"><span>Model Confidence</span><span id="confScore">‚Äî</span></div>
        <div class="conf-track"><div class="conf-fill" id="confFill" style="width:0%"></div></div>
        <p class="hint" id="confNote" style="margin-top:.5rem;"></p>
      </div>
    </div>

    <!-- ROI Calculator -->
    <div class="card c4">
      <h2 class="card-title"><span class="icon">üí∞</span>ROI Calculator</h2>
      <div class="igroup">
        <label>Monthly SEO Investment ($)</label>
        <input type="number" id="seoInvestment" value="5000" step="100" min="0">
        <p class="hint">üí° Agency fees + content + technical work</p>
      </div>
      <div class="mcard">
        <div class="mcard-label">Expected ROI (12 Months)</div>
        <div class="mcard-value green" id="roiPercentage">‚Äî</div>
      </div>
      <div style="margin-top:.85rem;padding:1rem;background:var(--input);border-radius:8px;font-size:.88rem;">
        <div style="display:flex;justify-content:space-between;margin-bottom:.5rem;">
          <span style="color:var(--fg2)">Total Investment</span>
          <span style="font-weight:700;" id="totalInvestment">‚Äî</span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:.5rem;">
          <span style="color:var(--fg2)">Revenue Gain (moderate)</span>
          <span style="color:var(--success);font-weight:700;" id="revenueGain">‚Äî</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding-top:.5rem;border-top:1px solid var(--border);">
          <span style="color:var(--fg2)">Payback Period</span>
          <span style="color:var(--accent);font-weight:700;" id="paybackPeriod">‚Äî</span>
        </div>
      </div>
    </div>

    <!-- Seasonality -->
    <div class="card c4">
      <h2 class="card-title"><span class="icon">üìÖ</span>Seasonality</h2>
      <div class="igroup">
        <label>Industry Type</label>
        <select id="industryType">
          <option value="none">No Seasonality</option>
          <option value="retail">Retail (Q4 Peak)</option>
          <option value="travel">Travel (Summer Peak)</option>
          <option value="fitness">Fitness (Jan / Summer Peak)</option>
          <option value="tax">Tax Services (Q1 Peak)</option>
          <option value="b2b">B2B (Low Summer)</option>
          <option value="ecomm">E-commerce (Black Friday)</option>
          <option value="edu">Education (Sep / Jan)</option>
        </select>
      </div>
      <div class="igroup">
        <label>Campaign Start Month</label>
        <select id="startMonth">
          <option value="0">January</option><option value="1">February</option>
          <option value="2">March</option><option value="3">April</option>
          <option value="4">May</option><option value="5">June</option>
          <option value="6">July</option><option value="7">August</option>
          <option value="8">September</option><option value="9">October</option>
          <option value="10">November</option><option value="11">December</option>
        </select>
      </div>
      <div class="mcard" style="margin-top:.75rem;">
        <div class="mcard-label">Peak Month Uplift</div>
        <div class="mcard-value" id="peakImpact">+0%</div>
      </div>
      <p class="hint" style="margin-top:.75rem;">üåä Adjusts monthly revenue using industry seasonality curves</p>
    </div>

  </div><!-- /ROW 2 -->

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ROW 3 ‚Äî ADVANCED: DR / KD ANALYSIS
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="grid advanced-only" id="ahrefsAnalysisRow">
    <div class="card c12">
      <h2 class="card-title"><span class="icon">üü£</span>Ahrefs-Powered Model Adjustments</h2>
      <div class="igrid4" style="gap:1.25rem;">

        <div>
          <div class="mcard-label">DR Gap Analysis</div>
          <div id="drGaugeWrap">
            <div style="text-align:center;padding:1rem;color:var(--fg2);font-size:.85rem;">Enter DR values above</div>
          </div>
        </div>

        <div>
          <div class="mcard-label">Ranking Probability by KD</div>
          <div id="kdBarsWrap">
            <div style="text-align:center;padding:1rem;color:var(--fg2);font-size:.85rem;">Enter KD above</div>
          </div>
        </div>

        <div>
          <div class="mcard-label">Backlink Gap</div>
          <div id="backlinkGapWrap">
            <div style="text-align:center;padding:1rem;color:var(--fg2);font-size:.85rem;">Enter domain data above</div>
          </div>
        </div>

        <div>
          <div class="mcard-label">Commercial Intent Score</div>
          <div id="commercialIntentWrap">
            <div style="text-align:center;padding:1rem;color:var(--fg2);font-size:.85rem;">Enter CPC above</div>
          </div>
        </div>

      </div>

      <!-- Adjustment summary -->
      <div id="adjustmentSummary" style="margin-top:1.25rem;padding:1rem;background:rgba(102,16,242,.1);border-radius:10px;border:1px solid var(--indigo);display:none;">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:1.3rem;color:#a78bfa;margin-bottom:.75rem;letter-spacing:-.02em;">MODEL ADJUSTMENT FACTORS APPLIED</div>
        <div id="adjustmentItems" style="display:flex;flex-wrap:wrap;gap:.6rem;"></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ROW 4 ‚Äî REVENUE PROJECTIONS
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="grid">
    <div class="card c12">
      <h2 class="card-title"><span class="icon">üíµ</span>Revenue Projections ‚Äî Incremental
        <span id="modelBadge" class="badge badge-indigo" style="margin-left:auto;font-size:.75rem;">Basic Model</span>
      </h2>
      <div class="results-grid">
        <div class="result-box cons">
          <h4>Conservative <span id="consTimeBadge" class="badge badge-indigo" style="font-size:.65rem;">3‚Äì6 mo</span></h4>
          <div class="rval" id="revenueConservative">$0</div>
          <div class="rlabel">Monthly Revenue</div>
          <div class="rdiv">
            <div class="rlabel">Annual (with seasonality)</div>
            <div class="rval" style="font-size:2rem;" id="annualConservative">$0</div>
          </div>
        </div>
        <div class="result-box mod">
          <h4>Moderate <span id="modTimeBadge" class="badge badge-green" style="font-size:.65rem;">6‚Äì12 mo</span></h4>
          <div class="rval" id="revenueModerate">$0</div>
          <div class="rlabel">Monthly Revenue</div>
          <div class="rdiv">
            <div class="rlabel">Annual (with seasonality)</div>
            <div class="rval" style="font-size:2rem;" id="annualModerate">$0</div>
          </div>
        </div>
        <div class="result-box opt">
          <h4>Optimistic <span id="optTimeBadge" class="badge badge-magenta" style="font-size:.65rem;">12+ mo</span></h4>
          <div class="rval" id="revenueOptimistic">$0</div>
          <div class="rlabel">Monthly Revenue</div>
          <div class="rdiv">
            <div class="rlabel">Annual (with seasonality)</div>
            <div class="rval" style="font-size:2rem;" id="annualOptimistic">$0</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       CHARTS
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="grid">
    <div class="card c4">
      <h2 class="card-title"><span class="icon">üìà</span>Traffic Projection</h2>
      <div class="chart-wrap"><canvas id="trafficChart"></canvas></div>
    </div>
    <div class="card c4">
      <h2 class="card-title"><span class="icon">üìä</span>Revenue Comparison</h2>
      <div class="chart-wrap"><canvas id="revenueChart"></canvas></div>
    </div>
    <div class="card c4">
      <h2 class="card-title"><span class="icon">üé≤</span>Monte Carlo Forecast
        <button onclick="runMonteCarlo()" style="margin-left:auto;padding:.4rem 1rem;background:linear-gradient(135deg,var(--accent),var(--accent-light));border:none;border-radius:8px;color:#fff;font-weight:700;cursor:pointer;font-family:'Montserrat',sans-serif;font-size:.78rem;letter-spacing:-.02em;text-transform:uppercase;">Run</button>
      </h2>
      <div class="igroup" style="margin-bottom:.75rem;">
        <label>Simulations</label>
        <input type="number" id="monteCarloIterations" value="1000" min="100" max="10000" step="100">
      </div>
      <div class="chart-wrap" style="height:240px;"><canvas id="monteCarloChart"></canvas></div>
      <div id="monteCarloStats" style="margin-top:.75rem;display:none;padding:.85rem;background:var(--input);border-radius:8px;">
        <div style="margin-bottom:.6rem;padding-bottom:.6rem;border-bottom:1px solid var(--border);">
          <div style="color:var(--fg2);font-size:.78rem;margin-bottom:.2rem;">Month 12 Range</div>
          <div style="font-weight:700;font-size:.95rem;" id="mcRange">‚Äî</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;font-size:.82rem;">
          <div><div style="color:var(--fg2)">Median (P50)</div><div style="font-weight:700;" id="mcMedian">‚Äî</div></div>
          <div><div style="color:var(--fg2)">Average</div><div style="font-weight:700;" id="mcMean">‚Äî</div></div>
          <div><div style="color:var(--fg2)">Conservative (P10)</div><div style="font-weight:700;color:#a78bfa;" id="mcP10">‚Äî</div></div>
          <div><div style="color:var(--fg2)">Optimistic (P90)</div><div style="font-weight:700;color:var(--accent);" id="mcP90">‚Äî</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       HISTORICAL REVENUE ‚Äî DATA-DRIVEN FORECAST
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="grid" style="margin-top:1.5rem;">
    <div class="card c12">
      <h2 class="card-title">
        <span class="icon">üóìÔ∏è</span>Historical Revenue ‚Äî Data-Driven Forecast
        <span id="histGrowthBadge" class="growth-badge growth-pos" style="display:none;font-size:.72rem;"></span>
      </h2>
      <p style="font-size:.82rem;color:var(--fg2);margin-bottom:1.25rem;font-family:'Montserrat',sans-serif;">Enter past monthly SEO-attributed revenue to calibrate the 6-month forward forecast to your actual growth trajectory.</p>

      <!-- Month count selector -->
      <div class="hist-header">
        <div class="hist-month-count">
          <label>Months of data</label>
          <select id="histMonthCount" onchange="buildHistInputs()">
            <option value="3">3 months</option>
            <option value="6" selected>6 months</option>
            <option value="9">9 months</option>
            <option value="12">12 months</option>
          </select>
        </div>
        <div style="font-size:.78rem;color:var(--fg2);font-style:italic;">Enter revenue from oldest ‚Üí most recent. Leave blank to skip a month.</div>
      </div>

      <!-- Dynamic inputs -->
      <div class="hist-grid" id="histInputGrid"></div>

      <!-- Summary stats -->
      <div class="hist-stats" id="histStats" style="display:none;">
        <div class="hist-stat">
          <div class="hist-stat-label">Avg Monthly Revenue</div>
          <div class="hist-stat-value" id="histAvg" style="color:var(--accent);">‚Äî</div>
        </div>
        <div class="hist-stat">
          <div class="hist-stat-label">Peak Month</div>
          <div class="hist-stat-value" id="histPeak" style="color:var(--success);">‚Äî</div>
        </div>
        <div class="hist-stat">
          <div class="hist-stat-label">Month-on-Month Growth</div>
          <div class="hist-stat-value" id="histMoM" style="color:var(--warn);">‚Äî</div>
        </div>
        <div class="hist-stat">
          <div class="hist-stat-label">Projected M+6</div>
          <div class="hist-stat-value" id="histProj" style="color:var(--accent-light);">‚Äî</div>
        </div>
      </div>

      <!-- Combined historical + forecast chart -->
      <div class="hist-chart-wrap"><canvas id="histForecastChart"></canvas></div>

      <div style="margin-top:.85rem;padding:.85rem;background:rgba(255,0,255,.05);border-radius:10px;border-left:3px solid var(--accent);font-size:.78rem;color:var(--fg2);font-family:'Montserrat',sans-serif;line-height:1.7;">
        <strong style="color:var(--accent);">How it works:</strong> The forecast uses your historical growth rate (calculated via linear regression on your actual data) to project the next 6 months. P10/P90 confidence bands widen with each forward month to reflect increasing uncertainty. A flat or declining trend will show conservative projections ‚Äî strong growth compresses the range upward.
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       STAGGER CHART ‚Äî FULL WIDTH
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="grid" style="margin-top:1.5rem;">
    <div class="card c12">
      <h2 class="card-title"><span class="icon">üìâ</span>Monthly Revenue Ramp ‚Äî All Scenarios</h2>
      <p style="font-size:.82rem;color:var(--fg2);margin-bottom:1rem;font-family:'Montserrat',sans-serif;">12-month staggered revenue build across Conservative, Moderate, and Optimistic scenarios, with seasonality applied. Shows how revenue compounds month-by-month as rankings mature.</p>
      <div class="stagger-legend">
        <div class="stagger-legend-item"><div class="stagger-legend-dot" style="background:#6610f2;"></div>Conservative</div>
        <div class="stagger-legend-item"><div class="stagger-legend-dot" style="background:#00ff00;"></div>Moderate</div>
        <div class="stagger-legend-item"><div class="stagger-legend-dot" style="background:#ff00ff;"></div>Optimistic</div>
      </div>
      <div class="stagger-chart-wrap"><canvas id="staggerChart"></canvas></div>
    </div>
  </div>

  <!-- NOTES -->
  <div class="note-section">
    <h3>Methodology &amp; Assumptions</h3>
    <ul>
      <li><strong>Current Rankings (4‚Äì50):</strong> Captures all keywords where the client has an existing relevance signal with Google. Positions 21‚Äì50 generate near-zero current traffic but are significantly easier to move to top 5 than unranked keywords, making them high-value opportunities. Export via Ahrefs Site Explorer ‚Üí Organic Keywords ‚Üí filter Position 4‚Äì50.</li>
      <li><strong>Commercial Keywords:</strong> Transactional/commercial intent queries identified by CPC &gt; $0.50 or intent modifiers (buy, best, review, vs, price)</li>
      <li><strong>Blended CTR:</strong> Industry-specific CTR for positions 1‚Äì5 from Advanced Web Ranking or equivalent tool ‚Äî left blank intentionally for per-client input</li>
      <li><strong>Incremental Traffic Split:</strong> Current rankings (4‚Äì50) generate incremental traffic = projected top-5 traffic minus existing baseline. Positions 21‚Äì50 contribute near-zero current traffic but significant opportunity volume. Competitor gap keywords are treated as 100% incremental since the client has zero current ranking for them.</li>
      <li><strong>Two-Band Ranking Model:</strong> Keywords are split across two position bands ‚Äî Positions 1‚Äì5 (high-CTR, ~15‚Äì22% blended) and Positions 6‚Äì10 (lower-CTR, ~4‚Äì5% blended). Conservative assumes 20% of keywords reach top 5 and an additional 35% reach positions 6‚Äì10, making the floor more realistic. Timeline reflects when full traffic materialises, not when work starts.</li>
      <li><strong>Advanced Mode ‚Äî KD Weighting:</strong> % of keywords reaching top 5 adjusted per KD band (Easy &lt;30 / Medium 30‚Äì60 / Hard 60+) using DR-gated probability table</li>
      <li><strong>Advanced Mode ‚Äî Backlink Gap:</strong> Timeline extended if referring domain gap is large. Small (&lt;50): standard. Medium (50‚Äì200): +25% timeline. Large (&gt;200): +50% timeline</li>
      <li><strong>Advanced Mode ‚Äî SERP Feature Discount:</strong> CTR reduced proportionally for keywords dominated by featured snippets, shopping, or local packs</li>
      <li><strong>Advanced Mode ‚Äî CPC / Commercial Intent:</strong> High avg CPC (&gt;$2) boosts commercial keyword % estimate. Low CPC reduces it</li>
      <li><strong>Seasonality:</strong> Industry-specific monthly multipliers applied to annual projections and Monte Carlo. Based on Google Trends patterns</li>
      <li><strong>Monte Carlo:</strong> S-curve growth trajectories with randomised ramp speed, CTR variance, CVR variance, and seasonal noise. P10‚ÄìP90 confidence band shown over 12 months</li>
      <li><strong>Missing Inputs:</strong> Any optional field left blank defaults to neutral (no adjustment). The model degrades gracefully ‚Äî all scenarios remain calculable</li>
    </ul>
  </div>

  <footer><p>Calibre9 SEO Revenue Forecasting Dashboard ¬∑ All projections are estimates based on industry benchmarks and Ahrefs data</p></footer>

</div><!-- /container -->

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CONSTANTS & STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SEASONALITY = {
  none:   [1,1,1,1,1,1,1,1,1,1,1,1],
  retail: [0.85,0.85,0.9,0.95,1.0,1.0,1.0,1.05,1.1,1.2,1.4,1.5],
  travel: [0.7,0.75,0.85,0.95,1.1,1.3,1.4,1.35,1.1,0.9,0.8,0.75],
  fitness:[1.5,1.3,1.1,0.95,0.9,1.0,1.1,1.0,0.95,0.9,0.85,0.9],
  tax:    [1.8,1.6,1.4,1.2,0.8,0.7,0.7,0.7,0.8,0.9,1.0,1.2],
  b2b:    [1.1,1.1,1.15,1.2,1.1,0.8,0.7,0.75,1.0,1.15,1.2,0.9],
  ecomm:  [0.9,0.85,0.9,0.95,1.0,1.0,1.05,1.05,1.1,1.2,1.5,1.6],
  edu:    [0.85,0.9,1.0,1.05,1.0,0.8,0.7,0.8,1.3,1.3,1.1,0.95]
};

// Two-band model: top 5 (high CTR) + top 6-10 (lower CTR)
// Timeline reflects when FULL results materialise, not when work starts
const SCENARIO_DEFAULTS = {
  conservative:{ 
    top5reach:20,  top5ctr:15,
    top10reach:35, top10ctr:4,
    fullResultsMonth:10,
    timeline:'Full results: Month 9‚Äì12'
  },
  moderate:{ 
    top5reach:32,  top5ctr:18,
    top10reach:45, top10ctr:4.5,
    fullResultsMonth:7,
    timeline:'Full results: Month 6‚Äì9'
  },
  optimistic:{ 
    top5reach:45,  top5ctr:22,
    top10reach:55, top10ctr:5,
    fullResultsMonth:4,
    timeline:'Full results: Month 3‚Äì6'
  }
};

let currentScenario = 'conservative';
let mode = 'basic'; // 'basic' | 'advanced'
let trafficChart, revenueChart, monteCarloChart, staggerChart;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MODE TOGGLE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setMode(m) {
  mode = m;
  document.getElementById('btnBasic').classList.toggle('active', m === 'basic');
  document.getElementById('btnAdvanced').classList.toggle('active', m === 'advanced');

  document.querySelectorAll('.advanced-only').forEach(el => {
    if (m === 'advanced') {
      el.style.display = el.classList.contains('grid') ? 'grid' : 'block';
    } else {
      el.style.display = 'none';
    }
  });

  document.getElementById('dataSourceBadge').textContent = m === 'advanced' ? 'Ahrefs Mode' : 'Basic Mode';
  document.getElementById('modelBadge').textContent = m === 'advanced' ? 'Ahrefs-Adjusted Model' : 'Basic Model';
  calculate();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const $v = id => parseFloat(document.getElementById(id)?.value) || null;
const $s = id => document.getElementById(id)?.value;
const fmt = n => new Intl.NumberFormat('en-US').format(Math.round(n));
const fmtC = n => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(n));

function seasonalMultipliers() {
  const type = $s('industryType') || 'none';
  const start = parseInt($s('startMonth') || '0');
  const base = SEASONALITY[type] || SEASONALITY.none;
  return Array.from({length:12}, (_,i) => base[(start+i)%12]);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  AHREFS ADJUSTMENT MODEL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function computeAhrefsAdjustments() {
  const clientDR  = $v('clientDR');
  const compDR    = $v('compDR');
  const clientRD  = $v('clientRD');
  const compRD    = $v('compRD');
  const avgKD     = $v('avgKD');
  const serpPct   = $v('serpFeaturePct');
  const cpc       = $v('avgCPC');

  let reachMultiplier = 1;
  let ctrMultiplier   = 1;
  let commercialMultiplier = 1;
  let timelineShift = 0; // months to add
  let confidence = 40; // base confidence for basic
  let adjustments = [];
  let signals = [];

  if (mode === 'advanced') {
    confidence = 55; // advanced baseline

    // ‚îÄ‚îÄ DR vs competitor DR ‚îÄ‚îÄ
    if (clientDR !== null && compDR !== null) {
      confidence += 10;
      const drGap = compDR - clientDR;
      if (drGap > 20) {
        reachMultiplier *= 0.55;
        adjustments.push({ label:'DR Gap >20pts', value:'‚àí45% reach', color:'danger' });
        signals.push({ text:`DR Gap: ${drGap.toFixed(0)} pts`, color:'badge-danger' });
      } else if (drGap > 10) {
        reachMultiplier *= 0.75;
        adjustments.push({ label:'DR Gap 10‚Äì20pts', value:'‚àí25% reach', color:'warn' });
        signals.push({ text:`DR Gap: ${drGap.toFixed(0)} pts`, color:'badge-warn' });
      } else if (drGap > 0) {
        reachMultiplier *= 0.9;
        adjustments.push({ label:'DR Gap <10pts', value:'‚àí10% reach', color:'warn' });
        signals.push({ text:`DR Gap: ${drGap.toFixed(0)} pts`, color:'badge-warn' });
      } else {
        reachMultiplier *= 1.1;
        adjustments.push({ label:'Client DR ‚â• Competitor', value:'+10% reach', color:'green' });
        signals.push({ text:`DR Advantage: ${Math.abs(drGap).toFixed(0)} pts`, color:'badge-green' });
      }
    }

    // ‚îÄ‚îÄ KD-based ranking probability ‚îÄ‚îÄ
    if (avgKD !== null) {
      confidence += 10;
      if (avgKD <= 30) {
        reachMultiplier *= 1.3;
        adjustments.push({ label:`Low KD (${avgKD})`, value:'+30% reach', color:'green' });
        signals.push({ text:`KD ${avgKD} ‚Äî Easy`, color:'badge-green' });
      } else if (avgKD <= 60) {
        // neutral
        adjustments.push({ label:`Medium KD (${avgKD})`, value:'no change', color:'neutral' });
        signals.push({ text:`KD ${avgKD} ‚Äî Medium`, color:'badge-warn' });
      } else {
        reachMultiplier *= 0.65;
        adjustments.push({ label:`High KD (${avgKD})`, value:'‚àí35% reach', color:'danger' });
        signals.push({ text:`KD ${avgKD} ‚Äî Hard`, color:'badge-danger' });
      }
    }

    // ‚îÄ‚îÄ Backlink gap ‚Üí timeline ‚îÄ‚îÄ
    if (clientRD !== null && compRD !== null) {
      confidence += 8;
      const rdGap = compRD - clientRD;
      if (rdGap > 200) {
        timelineShift = 4;
        adjustments.push({ label:'Large RD Gap (>200)', value:'+4 mo timeline', color:'danger' });
        signals.push({ text:`RD Gap: ${fmt(rdGap)}`, color:'badge-danger' });
      } else if (rdGap > 50) {
        timelineShift = 2;
        adjustments.push({ label:'Medium RD Gap (50‚Äì200)', value:'+2 mo timeline', color:'warn' });
        signals.push({ text:`RD Gap: ${fmt(rdGap)}`, color:'badge-warn' });
      } else {
        signals.push({ text:`RD Gap: ${fmt(Math.max(0,rdGap))} (small)`, color:'badge-green' });
      }
    }

    // ‚îÄ‚îÄ SERP feature CTR discount ‚îÄ‚îÄ
    if (serpPct !== null) {
      confidence += 7;
      const discount = 1 - (serpPct / 100) * 0.35;
      ctrMultiplier *= discount;
      adjustments.push({ label:`SERP Features (${serpPct}%)`, value:`‚àí${(serpPct*0.35).toFixed(0)}% CTR`, color: serpPct>30?'danger':'warn' });
      signals.push({ text:`SERP Features: ${serpPct}%`, color: serpPct>30?'badge-danger':'badge-warn' });
    }

    // ‚îÄ‚îÄ CPC ‚Üí commercial intent boost ‚îÄ‚îÄ
    if (cpc !== null) {
      confidence += 5;
      if (cpc > 3) {
        commercialMultiplier = 1.2;
        adjustments.push({ label:`High CPC ($${cpc})`, value:'+20% commercial %', color:'green' });
        signals.push({ text:`High CPC: $${cpc}`, color:'badge-green' });
      } else if (cpc > 1) {
        commercialMultiplier = 1.05;
        adjustments.push({ label:`Med CPC ($${cpc})`, value:'+5% commercial %', color:'green' });
      } else if (cpc < 0.3) {
        commercialMultiplier = 0.8;
        adjustments.push({ label:`Low CPC ($${cpc})`, value:'‚àí20% commercial %', color:'warn' });
        signals.push({ text:`Low CPC: $${cpc}`, color:'badge-warn' });
      }
    }

    confidence = Math.min(confidence, 92);
  }

  return { reachMultiplier, ctrMultiplier, commercialMultiplier, timelineShift, confidence, adjustments, signals };
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  RENDER AHREFS ANALYSIS PANELS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAhrefsAnalysis(adj) {
  if (mode !== 'advanced') return;

  const clientDR = $v('clientDR'), compDR = $v('compDR');
  const clientRD = $v('clientRD'), compRD = $v('compRD');
  const avgKD    = $v('avgKD');
  const cpc      = $v('avgCPC');

  // DR gauge
  const drWrap = document.getElementById('drGaugeWrap');
  if (clientDR !== null || compDR !== null) {
    const cd = clientDR || 0, co = compDR || 0;
    drWrap.innerHTML = `
      <div style="display:flex;justify-content:space-between;margin-bottom:.5rem;font-size:.82rem;">
        <span>Client DR <strong style="color:var(--accent)">${cd}</strong></span>
        <span>Comp Avg DR <strong style="color:var(--fg2)">${co}</strong></span>
      </div>
      <div class="kd-bar-wrap">
        <div class="kd-bar-label"><span>0</span><span>100</span></div>
        <div class="kd-bar-track" style="height:10px;">
          <div class="kd-bar-fill" style="width:${cd}%;background:linear-gradient(90deg,var(--indigo),var(--accent));"></div>
        </div>
        <div style="margin-top:.3rem;font-size:.75rem;color:var(--fg2)">Client</div>
        <div class="kd-bar-track" style="height:10px;margin-top:.4rem;">
          <div class="kd-bar-fill" style="width:${co}%;background:var(--border);"></div>
        </div>
        <div style="margin-top:.3rem;font-size:.75rem;color:var(--fg2)">Competitor Avg</div>
      </div>
      <div class="badge ${(co-cd)>10?'badge-danger':(co-cd)>0?'badge-warn':'badge-green'}" style="margin-top:.75rem;">
        DR Gap: ${co > cd ? co-cd + ' pts behind' : Math.abs(co-cd) + ' pts ahead'}
      </div>`;
  } else {
    drWrap.innerHTML = '<div style="text-align:center;padding:1rem;color:var(--fg2);font-size:.85rem;">Enter DR values above</div>';
  }

  // KD bars
  const kdWrap = document.getElementById('kdBarsWrap');
  if (avgKD !== null) {
    const probs = clientDR !== null ?
      (clientDR >= 50 ? [75,40,15] : clientDR >= 30 ? [55,22,7] : [30,10,3]) :
      (avgKD <= 30 ? [55,25,8] : avgKD <= 60 ? [35,18,6] : [15,7,2]);
    const labels = ['Easy KD <30','Med KD 30‚Äì60','Hard KD 60+'];
    const colors = ['var(--success)','var(--warn)','var(--danger)'];
    kdWrap.innerHTML = labels.map((l,i) => `
      <div style="margin-bottom:.6rem;">
        <div class="kd-bar-label"><span>${l}</span><span>${probs[i]}%</span></div>
        <div class="kd-bar-track"><div class="kd-bar-fill" style="width:${probs[i]}%;background:${colors[i]};"></div></div>
      </div>`).join('') +
      `<div style="font-size:.75rem;color:var(--fg2);margin-top:.5rem;">Your avg KD: <strong style="color:var(--fg)">${avgKD}</strong></div>`;
  } else {
    kdWrap.innerHTML = '<div style="text-align:center;padding:1rem;color:var(--fg2);font-size:.85rem;">Enter KD above</div>';
  }

  // Backlink gap
  const blWrap = document.getElementById('backlinkGapWrap');
  if (clientRD !== null || compRD !== null) {
    const cr = clientRD || 0, co2 = compRD || 0, gap = co2 - cr;
    const severity = gap > 200 ? 'danger' : gap > 50 ? 'warn' : 'green';
    const label = gap > 200 ? 'Large Gap' : gap > 50 ? 'Medium Gap' : gap > 0 ? 'Small Gap' : 'No Gap';
    blWrap.innerHTML = `
      <div style="font-size:.85rem;margin-bottom:.75rem;">
        <div style="display:flex;justify-content:space-between;margin-bottom:.3rem;">
          <span style="color:var(--fg2)">Client Ref. Domains</span><strong>${fmt(cr)}</strong>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span style="color:var(--fg2)">Competitor Avg</span><strong>${fmt(co2)}</strong>
        </div>
      </div>
      <div class="badge badge-${severity}" style="margin-bottom:.5rem;">${label}: ${fmt(Math.abs(gap))} domains</div>
      ${gap > 0 ? `<div style="font-size:.75rem;color:var(--fg2);margin-top:.5rem;">Timeline impact: +${adj.timelineShift} months added</div>` : ''}`;
  } else {
    blWrap.innerHTML = '<div style="text-align:center;padding:1rem;color:var(--fg2);font-size:.85rem;">Enter domain data above</div>';
  }

  // Commercial intent
  const ciWrap = document.getElementById('commercialIntentWrap');
  if (cpc !== null) {
    const tier = cpc > 3 ? {label:'High',color:'badge-green',note:'Strong purchase intent'}
                 : cpc > 1 ? {label:'Medium',color:'badge-warn',note:'Mixed intent keywords'}
                 : {label:'Low',color:'badge-danger',note:'Informational bias'};
    ciWrap.innerHTML = `
      <div style="font-size:2rem;font-family:'Bebas Neue',sans-serif;letter-spacing:-.02em;">$${cpc.toFixed(2)} avg CPC</div>
      <div class="badge ${tier.color}" style="margin:.5rem 0;">${tier.label} Commercial Intent</div>
      <div style="font-size:.78rem;color:var(--fg2);">${tier.note}</div>
      <div style="font-size:.78rem;color:var(--fg2);margin-top:.4rem;">Multiplier applied to commercial %: √ó${adj.commercialMultiplier.toFixed(2)}</div>`;
  } else {
    ciWrap.innerHTML = '<div style="text-align:center;padding:1rem;color:var(--fg2);font-size:.85rem;">Enter CPC above</div>';
  }

  // Adjustment summary
  const summaryEl = document.getElementById('adjustmentSummary');
  const itemsEl   = document.getElementById('adjustmentItems');
  if (adj.adjustments.length > 0) {
    summaryEl.style.display = '';
    itemsEl.innerHTML = adj.adjustments.map(a => `
      <div class="badge ${a.color==='green'?'badge-green':a.color==='danger'?'badge-danger':a.color==='warn'?'badge-warn':'badge-indigo'}">
        ${a.label}: <strong>${a.value}</strong>
      </div>`).join('');
  } else {
    summaryEl.style.display = 'none';
  }

  // Signals
  document.getElementById('ahrefsSignals').innerHTML = adj.signals.map(s =>
    `<span class="badge ${s.color}">${s.text}</span>`).join('');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  SCENARIO SWITCH
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchScenario(s, e) {
  currentScenario = s;
  document.querySelectorAll('.stab').forEach(t => t.classList.remove('active'));
  if (e) e.target.classList.add('active');
  const pre = SCENARIO_DEFAULTS[s];
  document.getElementById('scenarioTop5Reach').value  = pre.top5reach;
  document.getElementById('scenarioTop5CTR').value    = pre.top5ctr;
  document.getElementById('scenarioTop10Reach').value = pre.top10reach;
  document.getElementById('scenarioTop10CTR').value   = pre.top10ctr;
  document.getElementById('timeline').textContent     = pre.timeline;
  calculate();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MAIN CALCULATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calculate() {
  const cvr        = ($v('conversionRate') || 3.2) / 100;
  const aov        = $v('aov') || 285;
  const commPct    = ($v('commercialPercent') || 42) / 100;
  const currKw     = $v('currentKeywords') || 0;
  const currVol    = $v('currentVolume') || 0;
  const gapKw      = $v('gapKeywords') || 0;
  const gapVol     = $v('gapVolume') || 0;
  const currTraff  = $v('currentTraffic') || 0;
  const seoInv     = $v('seoInvestment') || 5000;

  const totalKw  = currKw + gapKw;
  const totalVol = currVol + gapVol;
  document.getElementById('totalOpportunity').textContent =
    `${fmt(totalKw)} Keywords ¬∑ ${fmt(totalVol)} Volume`;
  document.getElementById('currentTrafficDisplay') &&
    (document.getElementById('currentTrafficDisplay').textContent = fmt(currTraff));

  // Ahrefs adjustments
  const adj = computeAhrefsAdjustments();
  renderAhrefsAnalysis(adj);

  // Confidence score display
  const confPct = adj.confidence;
  document.getElementById('confScore').textContent = confPct + '% confidence';
  document.getElementById('confFill').style.width = confPct + '%';
  document.getElementById('confNote').textContent =
    confPct >= 75 ? '‚úÖ High data quality ‚Äî projections well-calibrated'
    : confPct >= 55 ? '‚ö†Ô∏è Moderate quality ‚Äî add Ahrefs data to improve'
    : 'üìä Basic estimate ‚Äî enter Ahrefs data for accuracy';

  // Build 3 scenarios ‚Äî two-band model (pos 1-5 + pos 6-10)
  const scenarios = ['conservative','moderate','optimistic'];
  const results = {};

  scenarios.forEach(sc => {
    const pre = SCENARIO_DEFAULTS[sc];

    // Apply Ahrefs reach multiplier to both bands
    const top5reach  = Math.min((pre.top5reach  / 100) * adj.reachMultiplier, 0.85);
    const top5ctr    = Math.min((pre.top5ctr    / 100) * adj.ctrMultiplier,   0.45);
    const top10reach = Math.min((pre.top10reach / 100) * adj.reachMultiplier, 0.85);
    const top10ctr   = Math.min((pre.top10ctr   / 100) * adj.ctrMultiplier,   0.15);
    const comm       = Math.min(commPct * adj.commercialMultiplier, 0.9);

    // ‚îÄ‚îÄ Current rankings (4-50): split traffic by band ‚îÄ‚îÄ
    // Top 5 band traffic from current ranking keywords
    const currTop5Traff  = currVol * comm * top5reach * top5ctr;
    // Top 6-10 band ‚Äî additional keywords that land here instead of top 5
    const currTop10Traff = currVol * comm * top10reach * top10ctr;
    // Incremental vs existing baseline (positions 4-50 already generate some traffic)
    const currIncrTraff  = Math.max(0, (currTop5Traff + currTop10Traff) - currTraff);

    // ‚îÄ‚îÄ Gap keywords: 100% incremental across both bands ‚îÄ‚îÄ
    const gapTop5Traff  = gapVol * comm * top5reach  * top5ctr;
    const gapTop10Traff = gapVol * comm * top10reach * top10ctr;
    const gapIncrTraff  = gapTop5Traff + gapTop10Traff;

    const incrTraff = currIncrTraff + gapIncrTraff;
    const orders    = incrTraff * cvr;
    const monthly   = orders * aov;

    const sm     = seasonalMultipliers();
    const annual = sm.reduce((acc, m) => acc + monthly * m, 0);

    results[sc] = { 
      traffic: incrTraff, monthly, annual,
      top5Traff: currTop5Traff + gapTop5Traff,
      top10Traff: currTop10Traff + gapTop10Traff,
      top5reach, top5ctr, top10reach, top10ctr, comm
    };
  });

  // Update result boxes
  document.getElementById('revenueConservative').textContent  = fmtC(results.conservative.monthly);
  document.getElementById('annualConservative').textContent   = fmtC(results.conservative.annual);
  document.getElementById('revenueModerate').textContent      = fmtC(results.moderate.monthly);
  document.getElementById('annualModerate').textContent       = fmtC(results.moderate.annual);
  document.getElementById('revenueOptimistic').textContent    = fmtC(results.optimistic.monthly);
  document.getElementById('annualOptimistic').textContent     = fmtC(results.optimistic.annual);

  // Timeline badges with shift
  const shift = adj.timelineShift;
  document.getElementById('consTimeBadge').textContent = shift > 0 ? `${3+shift}‚Äì${6+shift} mo` : '3‚Äì6 mo';
  document.getElementById('modTimeBadge').textContent  = shift > 0 ? `${6+shift}‚Äì${12+shift} mo` : '6‚Äì12 mo';
  document.getElementById('optTimeBadge').textContent  = shift > 0 ? `${12+shift}+ mo` : '12+ mo';

  // ROI
  const totalInv = seoInv * 12;
  const gain     = results.moderate.annual;
  const roi      = totalInv > 0 ? (((gain - totalInv) / totalInv) * 100).toFixed(1) : 0;
  const payback  = results.moderate.monthly > seoInv
    ? Math.ceil(totalInv / (results.moderate.monthly - seoInv))
    : results.moderate.monthly > 0 ? '12+' : 'N/A';

  document.getElementById('totalInvestment').textContent = fmtC(totalInv);
  document.getElementById('revenueGain').textContent     = fmtC(gain);
  document.getElementById('paybackPeriod').textContent   = (typeof payback === 'number') ? payback + ' months' : payback;
  const roiEl = document.getElementById('roiPercentage');
  roiEl.textContent   = roi + '%';
  roiEl.className = 'mcard-value ' + (roi >= 100 ? 'green' : roi >= 0 ? 'magenta' : '');
  roiEl.style.color   = roi < 0 ? 'var(--danger)' : '';

  // Seasonality peak
  const sm2 = seasonalMultipliers();
  document.getElementById('peakImpact').textContent =
    '+' + (((Math.max(...sm2) - 1) * 100).toFixed(0)) + '%';

  // Update charts
  updateCharts(currTraff, results);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CHARTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CHART_OPTS_BASE = {
  responsive:true, maintainAspectRatio:false,
  plugins:{
    legend:{display:false},
    tooltip:{
      backgroundColor:'rgba(26,26,26,.95)',
      titleColor:'#fff', bodyColor:'#fff',
      borderColor:'#3a3a3a', borderWidth:1, padding:10, displayColors:false
    }
  },
  scales:{
    y:{ beginAtZero:true, grid:{color:'rgba(58,58,58,.4)'}, ticks:{color:'#b0b0b0'} },
    x:{ grid:{display:false}, ticks:{color:'#b0b0b0'} }
  }
};

function updateCharts(baseline, results) {
  // Traffic chart
  if (trafficChart) trafficChart.destroy();
  trafficChart = new Chart(document.getElementById('trafficChart'), {
    type:'bar',
    data:{
      labels:['Current','Conservative','Moderate','Optimistic'],
      datasets:[{
        data:[baseline, baseline+results.conservative.traffic, baseline+results.moderate.traffic, baseline+results.optimistic.traffic],
        backgroundColor:['rgba(102,16,242,.6)','rgba(102,16,242,.85)','rgba(0,255,0,.75)','rgba(255,0,255,.75)'],
        borderColor:['#6610f2','#6610f2','#00ff00','#ff00ff'],
        borderWidth:2, borderRadius:6
      }]
    },
    options:{...CHART_OPTS_BASE,
      plugins:{...CHART_OPTS_BASE.plugins,
        tooltip:{...CHART_OPTS_BASE.plugins.tooltip,
          callbacks:{label: ctx => fmt(ctx.parsed.y)+' visitors'}}},
      scales:{...CHART_OPTS_BASE.scales,
        y:{...CHART_OPTS_BASE.scales.y, ticks:{color:'#b0b0b0',callback:v=>fmt(v)}}}
    }
  });

  // Revenue chart
  if (revenueChart) revenueChart.destroy();
  revenueChart = new Chart(document.getElementById('revenueChart'), {
    type:'bar',
    data:{
      labels:['Conservative','Moderate','Optimistic'],
      datasets:[{
        data:[results.conservative.annual, results.moderate.annual, results.optimistic.annual],
        backgroundColor:['rgba(102,16,242,.8)','rgba(0,255,0,.75)','rgba(255,0,255,.75)'],
        borderColor:['#6610f2','#00ff00','#ff00ff'],
        borderWidth:2, borderRadius:6
      }]
    },
    options:{...CHART_OPTS_BASE,
      plugins:{...CHART_OPTS_BASE.plugins,
        tooltip:{...CHART_OPTS_BASE.plugins.tooltip,
          callbacks:{label: ctx => fmtC(ctx.parsed.y)+' annual'}}},
      scales:{...CHART_OPTS_BASE.scales,
        y:{...CHART_OPTS_BASE.scales.y, ticks:{color:'#b0b0b0',callback:v=>fmtC(v)}}}
    }
  });

  // ‚îÄ‚îÄ Stagger chart ‚Äî monthly ramp with S-curve growth ‚îÄ‚îÄ
  const sm = seasonalMultipliers();
  const months = Array.from({length:12}, (_,i) => `Month ${i+1}`);

  // S-curve ramp: each scenario has a different ramp speed
  const rampCurve = (month, fullResultsMonth) => {
    // Smooth S-curve: slow start, accelerates, plateaus at full results month
    const x = month / Math.max(fullResultsMonth, 1);
    return Math.min(1, (1 / (1 + Math.exp(-6 * (x - 0.5)))));
  };

  const buildMonthly = (sc) => {
    const pre = SCENARIO_DEFAULTS[sc];
    return months.map((_, i) => {
      const ramp = rampCurve(i, pre.fullResultsMonth);
      return results[sc].monthly * ramp * sm[i];
    });
  };

  const consData = buildMonthly('conservative');
  const modData  = buildMonthly('moderate');
  const optData  = buildMonthly('optimistic');

  if (staggerChart) staggerChart.destroy();
  staggerChart = new Chart(document.getElementById('staggerChart'), {
    type: 'bar',
    data: {
      labels: months,
      datasets: [
        {
          label: 'Conservative',
          data: consData,
          backgroundColor: 'rgba(102,16,242,.75)',
          borderColor: '#6610f2',
          borderWidth: 1,
          borderRadius: 3,
          order: 3
        },
        {
          label: 'Moderate',
          data: modData,
          backgroundColor: 'rgba(0,255,0,.7)',
          borderColor: '#00ff00',
          borderWidth: 1,
          borderRadius: 3,
          order: 2
        },
        {
          label: 'Optimistic',
          data: optData,
          backgroundColor: 'rgba(255,0,255,.7)',
          borderColor: '#ff00ff',
          borderWidth: 1,
          borderRadius: 3,
          order: 1
        },
        // Line overlay: moderate trend
        {
          label: 'Moderate Trend',
          data: modData,
          type: 'line',
          borderColor: 'rgba(0,255,0,1)',
          borderWidth: 2.5,
          pointBackgroundColor: '#00ff00',
          pointRadius: 3,
          fill: false,
          tension: 0.4,
          order: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(26,26,26,.97)',
          titleColor: '#fff',
          bodyColor: '#b0b0b0',
          borderColor: '#3a3a3a',
          borderWidth: 1,
          padding: 12,
          callbacks: {
            label: ctx => ctx.dataset.label === 'Moderate Trend' ? null : `${ctx.dataset.label}: ${fmtC(ctx.parsed.y)}`
          }
        }
      },
      scales: {
        x: {
          grid: { color: 'rgba(58,58,58,.2)' },
          ticks: { color: '#b0b0b0', font: { size: 11 } }
        },
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(58,58,58,.4)' },
          ticks: { color: '#b0b0b0', callback: v => fmtC(v) }
        }
      }
    }
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MONTE CARLO
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function runMonteCarlo() {
  const iters   = parseInt(document.getElementById('monteCarloIterations').value) || 1000;
  const cvr     = ($v('conversionRate') || 3.2) / 100;
  const aov     = $v('aov') || 285;
  const comm    = ($v('commercialPercent') || 42) / 100;
  const totVol  = ($v('currentVolume')||0) + ($v('gapVolume')||0);
  const currT   = $v('currentTraffic') || 0;
  const adj     = computeAhrefsAdjustments();
  const sm      = seasonalMultipliers();

  const monthly = Array.from({length:12}, () => []);

  const currVol2  = $v('currentVolume') || 0;
  const gapVol2   = $v('gapVolume') || 0;

  // Read current scenario's band values as targets
  const targetTop5Reach  = ($v('scenarioTop5Reach')  || 20) / 100;
  const targetTop5CTR    = ($v('scenarioTop5CTR')    || 15) / 100;
  const targetTop10Reach = ($v('scenarioTop10Reach') || 35) / 100;
  const targetTop10CTR   = ($v('scenarioTop10CTR')   || 4)  / 100;

  for (let i = 0; i < iters; i++) {
    const growthRate  = 0.6 + Math.random() * 0.8;
    const startDelay  = Math.floor(Math.random() * 3);
    for (let m = 0; m < 12; m++) {
      const prog = 1 - Math.exp(-growthRate * Math.max(0, m - startDelay) / 6);
      const rnd  = () => 1 + (Math.random() - 0.5) * 0.3;

      const top5r  = Math.max(0.01, Math.min(0.8,  targetTop5Reach  * adj.reachMultiplier * prog * rnd()));
      const top5c  = Math.max(0.01, Math.min(0.45, targetTop5CTR    * adj.ctrMultiplier   * prog * rnd()));
      const top10r = Math.max(0.01, Math.min(0.8,  targetTop10Reach * adj.reachMultiplier * prog * rnd()));
      const top10c = Math.max(0.01, Math.min(0.12, targetTop10CTR   * adj.ctrMultiplier   * prog * rnd()));
      const c      = Math.max(0.05, Math.min(0.8,  comm * adj.commercialMultiplier * (1+(Math.random()-.5)*.2)));
      const cv     = Math.max(0.002, Math.min(0.12, cvr * (1+(Math.random()-.5)*.25)));

      // Two-band traffic: current rankings incremental + gap keywords
      const currT5   = currVol2 * c * top5r  * top5c;
      const currT10  = currVol2 * c * top10r * top10c;
      const currIncr = Math.max(0, currT5 + currT10 - currT);
      const gapT     = gapVol2 * c * (top5r * top5c + top10r * top10c);

      const rev = Math.max(0, (currIncr + gapT) * cv * aov * sm[m]);
      monthly[m].push(rev);
    }
  }

  const pct = (arr, p) => { const s=[...arr].sort((a,b)=>a-b); return s[Math.floor(s.length*p)]; };
  const p10 = monthly.map(a => pct(a,.10));
  const p50 = monthly.map(a => pct(a,.50));
  const p90 = monthly.map(a => pct(a,.90));
  const avg = monthly.map(a => a.reduce((s,v)=>s+v,0)/a.length);

  const lm = 11;
  document.getElementById('monteCarloStats').style.display = '';
  document.getElementById('mcRange').textContent   = `${fmtC(p10[lm])} ‚Äì ${fmtC(p90[lm])}`;
  document.getElementById('mcMedian').textContent  = fmtC(p50[lm]);
  document.getElementById('mcMean').textContent    = fmtC(avg[lm]);
  document.getElementById('mcP10').textContent     = fmtC(p10[lm]);
  document.getElementById('mcP90').textContent     = fmtC(p90[lm]);

  const labels = Array.from({length:12},(_,i)=>`M${i+1}`);
  if (monteCarloChart) monteCarloChart.destroy();
  monteCarloChart = new Chart(document.getElementById('monteCarloChart'), {
    type:'line',
    data:{
      labels,
      datasets:[
        { label:'P90', data:p90, borderColor:'rgba(255,0,255,.85)', backgroundColor:'rgba(255,0,255,.08)', borderWidth:2, fill:'+1', pointRadius:0, tension:.4 },
        { label:'Expected (P50)', data:p50, borderColor:'rgba(0,255,0,1)', borderWidth:3, fill:false, pointRadius:3, pointBackgroundColor:'#00ff00', tension:.4 },
        { label:'P10', data:p10, borderColor:'rgba(102,16,242,.85)', backgroundColor:'rgba(102,16,242,.08)', borderWidth:2, fill:false, pointRadius:0, tension:.4 }
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{display:true,position:'top',labels:{color:'#b0b0b0',usePointStyle:true,padding:8,font:{size:10}}},
        tooltip:{backgroundColor:'rgba(26,26,26,.95)',titleColor:'#fff',bodyColor:'#fff',borderColor:'#3a3a3a',borderWidth:1,padding:10,callbacks:{label:ctx=>ctx.dataset.label+': '+fmtC(ctx.parsed.y)}}
      },
      scales:{
        y:{beginAtZero:true,grid:{color:'rgba(58,58,58,.3)'},ticks:{color:'#b0b0b0',callback:v=>fmtC(v)}},
        x:{grid:{color:'rgba(58,58,58,.2)'},ticks:{color:'#b0b0b0'}}
      }
    }
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  HISTORICAL REVENUE FORECAST
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let histForecastChart = null;
const MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

function buildHistInputs() {
  const n = parseInt(document.getElementById('histMonthCount').value);
  const grid = document.getElementById('histInputGrid');
  const now = new Date();
  grid.innerHTML = '';
  for (let i = n - 1; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const label = `${MONTH_NAMES[d.getMonth()]} ${d.getFullYear()}`;
    const idx = n - 1 - i;
    grid.innerHTML += `
      <div class="hist-input-wrap">
        <label>${label}</label>
        <input type="number" id="hist_${idx}" placeholder="$0" min="0" step="100" oninput="updateHistForecast()">
      </div>`;
  }
  updateHistForecast();
}

function linReg(data) {
  // data = [{x, y}] ‚Äî returns {slope, intercept, r2}
  const n = data.length;
  if (n < 2) return { slope: 0, intercept: data[0]?.y || 0, r2: 0 };
  const sumX  = data.reduce((s, p) => s + p.x, 0);
  const sumY  = data.reduce((s, p) => s + p.y, 0);
  const sumXY = data.reduce((s, p) => s + p.x * p.y, 0);
  const sumX2 = data.reduce((s, p) => s + p.x * p.x, 0);
  const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
  const intercept = (sumY - slope * sumX) / n;
  const yMean = sumY / n;
  const ssTot = data.reduce((s, p) => s + Math.pow(p.y - yMean, 2), 0);
  const ssRes = data.reduce((s, p) => s + Math.pow(p.y - (slope * p.x + intercept), 2), 0);
  const r2 = ssTot > 0 ? 1 - ssRes / ssTot : 0;
  return { slope, intercept, r2 };
}

function updateHistForecast() {
  const n = parseInt(document.getElementById('histMonthCount').value);
  const values = [];
  for (let i = 0; i < n; i++) {
    const v = parseFloat(document.getElementById(`hist_${i}`)?.value);
    if (!isNaN(v) && v >= 0) values.push({ x: i, y: v, idx: i });
  }

  const statsEl = document.getElementById('histStats');
  if (values.length < 2) {
    statsEl.style.display = 'none';
    document.getElementById('histGrowthBadge').style.display = 'none';
    if (histForecastChart) { histForecastChart.destroy(); histForecastChart = null; }
    return;
  }

  statsEl.style.display = 'grid';

  // Stats
  const yVals = values.map(v => v.y);
  const avg = yVals.reduce((a, b) => a + b, 0) / yVals.length;
  const peak = Math.max(...yVals);

  // MoM growth (last two filled values)
  const last = values[values.length - 1].y;
  const prev = values[values.length - 2].y;
  const mom = prev > 0 ? ((last - prev) / prev * 100) : 0;

  document.getElementById('histAvg').textContent = fmtC(avg);
  document.getElementById('histPeak').textContent = fmtC(peak);
  document.getElementById('histMoM').textContent = (mom >= 0 ? '+' : '') + mom.toFixed(1) + '%';
  document.getElementById('histMoM').style.color = mom >= 0 ? 'var(--success)' : 'var(--danger)';

  // Linear regression
  const reg = linReg(values);
  const forecastMonths = 6;
  const projStart = n; // index after last historical point

  // Build 6-month forecast with widening uncertainty bands
  const projP50 = [], projP10 = [], projP90 = [];
  for (let f = 0; f < forecastMonths; f++) {
    const x = projStart + f;
    const base = Math.max(0, reg.slope * x + reg.intercept);
    // Uncertainty widens with each forward month; influenced by R¬≤
    const uncertainty = base * (0.1 + f * 0.06) * (1 - reg.r2 * 0.5);
    projP50.push(base);
    projP10.push(Math.max(0, base - uncertainty * 1.5));
    projP90.push(base + uncertainty * 1.5);
  }

  const projectedM6 = projP50[projP50.length - 1];
  document.getElementById('histProj').textContent = fmtC(projectedM6);

  // Growth badge
  const totalGrowth = last > 0 ? ((projectedM6 - last) / last * 100) : 0;
  const badge = document.getElementById('histGrowthBadge');
  badge.style.display = 'inline-flex';
  badge.className = 'growth-badge ' + (totalGrowth >= 0 ? 'growth-pos' : 'growth-neg');
  badge.textContent = (totalGrowth >= 0 ? '‚Üë ' : '‚Üì ') + Math.abs(totalGrowth).toFixed(1) + '% projected growth over 6mo';

  // Build chart labels
  const now = new Date();
  const allLabels = [];
  for (let i = n - 1; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    allLabels.push(`${MONTH_NAMES[d.getMonth()]} '${String(d.getFullYear()).slice(2)}`);
  }
  for (let f = 1; f <= forecastMonths; f++) {
    const d = new Date(now.getFullYear(), now.getMonth() + f, 1);
    allLabels.push(`${MONTH_NAMES[d.getMonth()]} '${String(d.getFullYear()).slice(2)}`);
  }

  // Historical data padded with nulls for forecast region
  const histData = Array(n).fill(null);
  values.forEach(v => { histData[v.idx] = v.y; });
  const histPadded = [...histData, ...Array(forecastMonths).fill(null)];

  // Regression line through all historical points + projected
  const regLine = allLabels.map((_, i) => Math.max(0, reg.slope * i + reg.intercept));

  // Forecast bands (null for historical region)
  const p50Full  = [...Array(n).fill(null), ...projP50];
  const p10Full  = [...Array(n).fill(null), ...projP10];
  const p90Full  = [...Array(n).fill(null), ...projP90];

  // Bridge point ‚Äî connect last historical to forecast
  const bridgeIdx = n - 1;
  if (histData[bridgeIdx] !== null) {
    p50Full[bridgeIdx] = histData[bridgeIdx];
    p10Full[bridgeIdx] = histData[bridgeIdx];
    p90Full[bridgeIdx] = histData[bridgeIdx];
  }

  if (histForecastChart) histForecastChart.destroy();
  histForecastChart = new Chart(document.getElementById('histForecastChart'), {
    type: 'line',
    data: {
      labels: allLabels,
      datasets: [
        // P90 upper band
        {
          label: 'Optimistic (P90)',
          data: p90Full,
          borderColor: 'rgba(255,0,255,.5)',
          backgroundColor: 'rgba(255,0,255,.07)',
          borderWidth: 1.5,
          borderDash: [4,3],
          pointRadius: 0,
          fill: '+1',
          tension: 0.4
        },
        // P50 median forecast
        {
          label: 'Forecast (median)',
          data: p50Full,
          borderColor: 'rgba(255,0,255,.95)',
          backgroundColor: 'transparent',
          borderWidth: 2.5,
          pointRadius: 4,
          pointBackgroundColor: '#ff00ff',
          fill: false,
          tension: 0.4
        },
        // P10 lower band
        {
          label: 'Conservative (P10)',
          data: p10Full,
          borderColor: 'rgba(102,16,242,.5)',
          backgroundColor: 'rgba(102,16,242,.07)',
          borderWidth: 1.5,
          borderDash: [4,3],
          pointRadius: 0,
          fill: false,
          tension: 0.4
        },
        // Actual historical bars
        {
          label: 'Actual Revenue',
          data: histPadded,
          type: 'bar',
          backgroundColor: allLabels.map((_, i) => i < n ? 'rgba(0,255,0,.65)' : 'transparent'),
          borderColor: allLabels.map((_, i) => i < n ? '#00ff00' : 'transparent'),
          borderWidth: 1,
          borderRadius: 4,
          order: 10
        },
        // Trend line
        {
          label: 'Trend',
          data: regLine,
          borderColor: 'rgba(255,204,0,.4)',
          borderWidth: 1.5,
          borderDash: [6,4],
          pointRadius: 0,
          fill: false,
          tension: 0,
          order: 5
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: { color: '#b0b0b0', usePointStyle: true, padding: 14, font: { size: 11 } }
        },
        tooltip: {
          backgroundColor: 'rgba(26,26,26,.97)',
          titleColor: '#fff',
          bodyColor: '#b0b0b0',
          borderColor: '#3a3a3a',
          borderWidth: 1,
          padding: 12,
          callbacks: {
            label: ctx => {
              if (ctx.parsed.y === null) return null;
              return `${ctx.dataset.label}: ${fmtC(ctx.parsed.y)}`;
            }
          }
        },
        annotation: undefined
      },
      scales: {
        x: {
          grid: { color: 'rgba(58,58,58,.2)' },
          ticks: { color: '#b0b0b0', font: { size: 11 } }
        },
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(58,58,58,.4)' },
          ticks: { color: '#b0b0b0', callback: v => fmtC(v) }
        }
      }
    }
  });

  // Draw forecast region shading via plugin
  const forecastStartX = n - 1;
  histForecastChart.options.plugins.beforeDraw = undefined;

  // Add vertical divider via custom plugin ‚Äî drawn on chart
  Chart.register({
    id: 'forecastDivider_' + Date.now(),
    afterDraw(chart) {
      if (chart.canvas.id !== 'histForecastChart') return;
      const ctx2 = chart.ctx;
      const xScale = chart.scales.x;
      const yScale = chart.scales.y;
      if (!xScale || !yScale) return;
      const x = xScale.getPixelForValue(forecastStartX);
      ctx2.save();
      ctx2.beginPath();
      ctx2.moveTo(x, yScale.top);
      ctx2.lineTo(x, yScale.bottom);
      ctx2.strokeStyle = 'rgba(255,255,255,.15)';
      ctx2.lineWidth = 1.5;
      ctx2.setLineDash([5, 4]);
      ctx2.stroke();
      ctx2.restore();
      // Label
      ctx2.save();
      ctx2.font = '700 10px Montserrat, sans-serif';
      ctx2.fillStyle = 'rgba(255,255,255,.35)';
      ctx2.textAlign = 'left';
      ctx2.fillText('FORECAST ‚Üí', x + 6, yScale.top + 14);
      ctx2.restore();
    }
  });
}

// Initialise historical inputs on load
buildHistInputs();

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  EVENT LISTENERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('input,select').forEach(el => el.addEventListener('input', calculate));
calculate();
</script>
</body>
</html>
